<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Photoshoot Generator</title>
  <style>
    /* 🎨 Simplified and Cleaned UI */
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 40px auto;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    header {
      text-align: center;
      color: white;
      padding: 50px 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
    }
    header h1 {
      margin: 0 0 10px;
      font-size: 2.2em;
    }
    .api-status {
      text-align: center;
      padding: 10px;
      background: #f3f4f6;
      color: #374151;
      font-weight: 500;
    }
    .upload-section {
      padding: 40px;
      text-align: center;
    }
    .upload-area {
      border: 2px dashed #667eea;
      border-radius: 10px;
      padding: 40px;
      cursor: pointer;
      transition: 0.3s;
    }
    .upload-area:hover {
      background: #eef2ff;
    }
    .scene-selection {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .scene-option {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 20px;
      cursor: pointer;
      transition: 0.3s;
    }
    .scene-option.selected {
      border-color: #667eea;
      background: #eef2ff;
    }
    .generate-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 14px 40px;
      border-radius: 40px;
      font-size: 1em;
      margin-top: 30px;
      cursor: pointer;
      transition: 0.3s;
    }
    .generate-btn:hover {
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    .generate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .results-section {
      display: none;
      padding: 40px;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .result-card {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    .result-image {
      width: 100%;
      height: 250px;
      object-fit: cover;
      display: block;
    }
    .download-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }
    .error {
      color: #ef4444;
      background: #fef2f2;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>🚀 AI Photoshoot Generator</h1>
      <p>Generate realistic product photos using AI</p>
    </header>

    <div id="apiStatus" class="api-status">Checking server...</div>

    <section class="upload-section" id="uploadSection">
      <div id="errorMessage" class="error" style="display:none;"></div>
      
      <div class="upload-area" id="uploadArea">
        <p>📸 Click or Drag your product image here</p>
        <input type="file" id="fileInput" hidden accept="image/*" />
        <img id="previewImage" style="max-width:200px; margin-top:10px; display:none;" />
      </div>

      <h3>Select Scene</h3>
      <div class="scene-selection" id="sceneSelection"></div>

      <button id="generateBtn" class="generate-btn" disabled>Generate</button>
    </section>

    <div id="loadingSection" class="loading">
      <h3>Generating image...</h3>
      <p>Please wait while AI creates your photoshoot ✨</p>
    </div>

    <section class="results-section" id="resultsSection">
      <h2>Results</h2>
      <div class="results-grid" id="resultsGrid"></div>
      <div style="text-align:center; margin-top:20px;">
        <button class="generate-btn" onclick="resetApp()">Generate Another</button>
      </div>
    </section>
  </div>

  <script>
    class PhotoshootApp {
      constructor() {
        this.selectedScene = null;
        this.uploadedFile = null;
        this.apiReady = false;
        this.init();
      }

      async init() {
        this.bindEvents();
        await this.checkStatus();
        await this.loadScenes();
      }

      bindEvents() {
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");
        const generateBtn = document.getElementById("generateBtn");

        uploadArea.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) => this.handleFile(e.target.files[0]));
        
        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.style.background = "#eef2ff";
        });
        
        uploadArea.addEventListener("dragleave", () => {
          uploadArea.style.background = "";
        });
        
        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.style.background = "";
          this.handleFile(e.dataTransfer.files[0]);
        });

        generateBtn.addEventListener("click", () => this.generate());
      }

      showError(message) {
        const errorEl = document.getElementById("errorMessage");
        errorEl.textContent = message;
        errorEl.style.display = "block";
        setTimeout(() => {
          errorEl.style.display = "none";
        }, 5000);
      }

      async checkStatus() {
        try {
          const res = await fetch("/api");
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          document.getElementById("apiStatus").textContent = `✅ ${data.message || "Server connected"}`;
          this.apiReady = true;
        } catch (err) {
          document.getElementById("apiStatus").textContent = "❌ Server not reachable";
          this.showError("Cannot connect to server. Please make sure the backend is running.");
        }
      }

      async loadScenes() {
        try {
          const res = await fetch("/api/scenes");
          if (!res.ok) throw new Error("Failed to load scenes");
          const scenes = await res.json();
          const section = document.getElementById("sceneSelection");

          section.innerHTML = scenes
            .map(
              (s) => `
            <div class="scene-option" data-id="${s.id}">
              <h4>${s.id.charAt(0).toUpperCase() + s.id.slice(1)}</h4>
              <p>${s.description}</p>
            </div>`
            )
            .join("");

          document.querySelectorAll(".scene-option").forEach((el) =>
            el.addEventListener("click", () => this.selectScene(el))
          );
        } catch (err) {
          this.showError("Failed to load scenes. Please refresh the page.");
        }
      }

      selectScene(el) {
        document.querySelectorAll(".scene-option").forEach((opt) => opt.classList.remove("selected"));
        el.classList.add("selected");
        this.selectedScene = el.dataset.id;
        this.updateButton();
      }

      handleFile(file) {
        if (!file) return;
        
        if (!file.type.startsWith("image/")) {
          this.showError("Please select a valid image file (JPEG, PNG, etc.)");
          return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
          this.showError("File size too large. Maximum size is 10MB.");
          return;
        }

        this.uploadedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.getElementById("previewImage");
          preview.src = e.target.result;
          preview.style.display = "block";
          document.querySelector("#uploadArea p").textContent = "Image selected! Click to change.";
        };
        reader.onerror = () => {
          this.showError("Failed to read the image file.");
        };
        reader.readAsDataURL(file);
        this.updateButton();
      }

      updateButton() {
        document.getElementById("generateBtn").disabled = !(this.uploadedFile && this.selectedScene && this.apiReady);
      }

      async generate() {
        if (!this.uploadedFile || !this.selectedScene) {
          this.showError("Please select both an image and a scene.");
          return;
        }

        const formData = new FormData();
        formData.append("productImage", this.uploadedFile);
        formData.append("sceneType", this.selectedScene);

        document.getElementById("uploadSection").style.display = "none";
        document.getElementById("loadingSection").style.display = "block";

        try {
          const res = await fetch("/api/upload", { 
            method: "POST", 
            body: formData 
          });
          
          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || data.details || "Generation failed");
          }

          if (data.success) {
            this.showResult(data);
          } else {
            throw new Error(data.error || "Generation failed");
          }
        } catch (err) {
          console.error("Generation error:", err);
          this.showError("Generation failed: " + err.message);
          this.reset();
        }
      }

      showResult(data) {
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("resultsSection").style.display = "block";

        const grid = document.getElementById("resultsGrid");
        grid.innerHTML = `
          <div class="result-card">
            <img src="${data.generatedImage}" class="result-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI1MCIgdmlld0JveD0iMCAwIDI4MCAyNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyODAiIGhlaWdodD0iMjUwIiBmaWxsPSIjRjNGNEY2Ii8+Cjx0ZXh0IHg9IjE0MCIgeT0iMTI1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNkI3MjgwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiPkltYWdlIG5vdCBmb3VuZDwvdGV4dD4KPC9zdmc+'"/>
            <div style="padding:10px;text-align:center;">
              <button class="download-btn" onclick="downloadImage('${data.generatedImage}', 'ai-photoshoot-${data.sceneType}.png')">⬇️ Download</button>
            </div>
          </div>
        `;
      }

      reset() {
        this.selectedScene = null;
        this.uploadedFile = null;
        document.getElementById("uploadSection").style.display = "block";
        document.getElementById("loadingSection").style.display = "none";
        document.getElementById("resultsSection").style.display = "none";
        document.getElementById("previewImage").style.display = "none";
        document.querySelector("#uploadArea p").textContent = "📸 Click or Drag your product image here";
        document.querySelectorAll(".scene-option").forEach(opt => opt.classList.remove("selected"));
        this.updateButton();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      window.app = new PhotoshootApp();
    });

    function resetApp() {
      window.app.reset();
    }

    function downloadImage(url, filename = "ai-photoshoot.png") {
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>